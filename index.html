<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilySafe - Live Location Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            min-height: 600px;
        }

        .map-container {
            flex: 1;
            min-width: 300px;
            height: 500px;
            border-right: 1px solid #eee;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .sidebar {
            flex: 0 0 350px;
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .family-members {
            max-height: 200px;
            overflow-y: auto;
        }

        .member {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }

        .member:hover {
            background: #f1f8ff;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
        }

        .member-status {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .status-online {
            color: #27ae60;
        }

        .status-offline {
            color: #e74c3c;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .consent-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .privacy-notice {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 10px;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        footer {
            text-align: center;
            padding: 15px;
            background: #2c3e50;
            color: white;
            font-size: 0.9rem;
        }

        .location-status {
            padding: 10px;
            background: #e8f4fd;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .location-info {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .map-container {
                height: 400px;
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .sidebar {
                flex: 1;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FamilySafe Tracker</h1>
            <p class="tagline">Stay connected with your loved ones - consensually and securely</p>
        </header>
        
        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="sidebar">
                <div class="section">
                    <h2>Family Members</h2>
                    <div class="family-members" id="familyMembers">
                        <!-- Family members will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>Location Controls</h2>
                    <div class="controls">
                        <button class="btn-primary" id="shareLocation">
                            <span>Share My Location</span>
                        </button>
                        <button class="btn-success" id="addMember">
                            <span>Add Family Member</span>
                        </button>
                        <button class="btn-danger" id="stopSharing">
                            <span>Stop Sharing</span>
                        </button>
                    </div>
                    <div class="location-status" id="locationStatus">
                        Location sharing is currently off
                    </div>
                    <div class="location-info" id="locationInfo">
                        Your location will appear here when sharing
                    </div>
                </div>
                
                <div class="section">
                    <h2>Privacy Settings</h2>
                    <div class="consent-toggle">
                        <span>Location Sharing Consent</span>
                        <label class="switch">
                            <input type="checkbox" id="consentToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-notice">
                        <p>Your location is only shared with family members you approve. You can revoke consent at any time.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>FamilySafe Tracker &copy; 2023 | All location sharing is consensual | Maps by <a href="https://www.openstreetmap.org/copyright" style="color: #3498db;">OpenStreetMap</a></p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map with a default view
        const map = L.map('map').setView([0, 0], 2);
        
        // Add OpenStreetMap tiles with proper attribution
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Add a message for the user
        const message = L.popup()
            .setLatLng([0, 0])
            .setContent('<div style="text-align:center;"><b>FamilySafe Tracker</b><br>Click "Share My Location" to start tracking</div>')
            .openOn(map);
        
        // Sample family members data
        let familyMembers = [
            { id: 1, name: "You", lat: 0, lng: 0, status: "offline", sharing: false, avatar: "Y" },
            { id: 2, name: "Alex Johnson", lat: 0, lng: 0, status: "offline", sharing: false, avatar: "A" },
            { id: 3, name: "Sam Johnson", lat: 0, lng: 0, status: "offline", sharing: false, avatar: "S" },
            { id: 4, name: "Casey Johnson", lat: 0, lng: 0, status: "offline", sharing: false, avatar: "C" }
        ];
        
        // Markers for each family member
        let markers = {};
        let locationWatchId = null;
        let userMarker = null;
        let userCircle = null;
        
        // Get color for member avatar based on ID
        function getColorForMember(id) {
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            return colors[id % colors.length];
        }
        
        // Add a marker for a family member
        function addMemberMarker(member) {
            // Remove existing marker if it exists
            if (markers[member.id]) {
                map.removeLayer(markers[member.id]);
            }
            
            // Create a custom icon
            const customIcon = L.divIcon({
                html: `<div style="background-color: ${getColorForMember(member.id)}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${member.avatar}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                className: 'member-marker'
            });
            
            const marker = L.marker([member.lat, member.lng], { icon: customIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: center;">
                        <b>${member.name}</b><br>
                        <span style="color: ${member.status === 'online' ? '#27ae60' : '#e74c3c'}">
                            ${member.status === 'online' ? 'Online' : 'Offline'}
                        </span><br>
                        Last updated: Just now
                    </div>
                `);
            
            markers[member.id] = marker;
            
            // Auto-open popup for the user's own marker
            if (member.id === 1 && member.sharing) {
                marker.openPopup();
            }
        }
        
        // Update user's location on the map
        function updateUserLocation(position) {
            const user = familyMembers.find(m => m.id === 1);
            if (user) {
                user.lat = position.coords.latitude;
                user.lng = position.coords.longitude;
                user.status = "online";
                
                // Remove existing user marker and circle if they exist
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                if (userCircle) {
                    map.removeLayer(userCircle);
                }
                
                // Add user marker
                userMarker = L.marker([user.lat, user.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center;">
                            <b>Your Location</b><br>
                            <span style="color: #27ae60">Online - Sharing location</span><br>
                            Accuracy: ${position.coords.accuracy ? Math.round(position.coords.accuracy) + 'm' : 'Unknown'}
                        </div>
                    `)
                    .openPopup();
                
                // Add accuracy circle
                if (position.coords.accuracy) {
                    userCircle = L.circle([user.lat, user.lng], {
                        color: '#3498db',
                        fillColor: '#3498db',
                        fillOpacity: 0.2,
                        radius: position.coords.accuracy
                    }).addTo(map);
                }
                
                // Center map on user's location
                map.setView([user.lat, user.lng], 15);
                
                // Update location info
                document.getElementById('locationInfo').innerHTML = `
                    <strong>Your Location:</strong><br>
                    Latitude: ${user.lat.toFixed(6)}<br>
                    Longitude: ${user.lng.toFixed(6)}<br>
                    Accuracy: ${position.coords.accuracy ? Math.round(position.coords.accuracy) + 'm' : 'Unknown'}<br>
                    Last updated: ${new Date().toLocaleTimeString()}
                `;
                
                // Update UI
                initializeUI();
            }
        }
        
        // Initialize the UI with family members
        function initializeUI() {
            const familyMembersContainer = document.getElementById('familyMembers');
            familyMembersContainer.innerHTML = '';
            
            familyMembers.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member';
                memberElement.innerHTML = `
                    <div class="member-avatar" style="background: ${getColorForMember(member.id)}">${member.avatar}</div>
                    <div class="member-info">
                        <div class="member-name">${member.name}</div>
                        <div class="member-status ${member.status === 'online' ? 'status-online' : 'status-offline'}">
                            ${member.status === 'online' ? 'Online' : 'Offline'} 
                            ${member.sharing ? '· Sharing location' : ''}
                        </div>
                    </div>
                `;
                familyMembersContainer.appendChild(memberElement);
            });
        }
        
        // Update location status message
        function updateLocationStatus(message, type = 'info') {
            const statusElement = document.getElementById('locationStatus');
            statusElement.textContent = message;
            
            // Reset classes
            statusElement.className = 'location-status';
            
            // Add type-based styling
            if (type === 'success') {
                statusElement.style.background = '#e8f6f3';
                statusElement.style.borderLeft = '4px solid #27ae60';
            } else if (type === 'error') {
                statusElement.style.background = '#fdeaea';
                statusElement.style.borderLeft = '4px solid #e74c3c';
            } else {
                statusElement.style.background = '#e8f4fd';
                statusElement.style.borderLeft = '4px solid #3498db';
            }
        }
        
        // Event listeners
        document.getElementById('shareLocation').addEventListener('click', function() {
            const consent = document.getElementById('consentToggle').checked;
            if (!consent) {
                alert("Please enable location sharing consent first.");
                return;
            }
            
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                return;
            }
            
            // Update button to show loading state
            const button = document.getElementById('shareLocation');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> Getting location...';
            button.disabled = true;
            
            // Get current position
            navigator.geolocation.getCurrentPosition(
                position => {
                    const user = familyMembers.find(m => m.id === 1);
                    if (user) {
                        user.sharing = true;
                        updateUserLocation(position);
                        updateLocationStatus("Location sharing is now active!", 'success');
                        
                        // Start watching position
                        if (locationWatchId) {
                            navigator.geolocation.clearWatch(locationWatchId);
                        }
                        
                        locationWatchId = navigator.geolocation.watchPosition(
                            position => {
                                updateUserLocation(position);
                            },
                            error => {
                                console.error("Error watching position:", error);
                                updateLocationStatus("Error updating location", 'error');
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 30000
                            }
                        );
                    }
                    
                    // Reset button
                    button.innerHTML = originalText;
                    button.disabled = false;
                },
                error => {
                    console.error("Error getting location:", error);
                    let errorMessage = "Unable to retrieve your location. ";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += "Location permission was denied.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMessage += "Location request timed out.";
                            break;
                        default:
                            errorMessage += "An unknown error occurred.";
                            break;
                    }
                    
                    updateLocationStatus(errorMessage, 'error');
                    
                    // Reset button
                    button.innerHTML = originalText;
                    button.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        });
        
        document.getElementById('stopSharing').addEventListener('click', function() {
            const user = familyMembers.find(m => m.id === 1);
            if (user) {
                user.sharing = false;
                user.status = "offline";
                
                if (userMarker) {
                    map.removeLayer(userMarker);
                    userMarker = null;
                }
                if (userCircle) {
                    map.removeLayer(userCircle);
                    userCircle = null;
                }
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                initializeUI();
                updateLocationStatus("Location sharing has been stopped.");
                document.getElementById('locationInfo').innerHTML = "Your location will appear here when sharing";
            }
        });
        
        document.getElementById('addMember').addEventListener('click', function() {
            const name = prompt("Enter the name of the family member to add:");
            if (name && name.trim() !== '') {
                // Generate a random location near the user (for demo purposes)
                const user = familyMembers.find(m => m.id === 1);
                let lat = 0, lng = 0;
                
                if (user && user.sharing) {
                    // If user is sharing, place new member nearby
                    lat = user.lat + (Math.random() - 0.5) * 0.01;
                    lng = user.lng + (Math.random() - 0.5) * 0.01;
                } else {
                    // Otherwise, use a random location
                    lat = (Math.random() - 0.5) * 180;
                    lng = (Math.random() - 0.5) * 360;
                }
                
                const newMember = {
                    id: familyMembers.length + 1,
                    name: name.trim(),
                    lat: lat,
                    lng: lng,
                    status: "online",
                    sharing: true,
                    avatar: name.trim().charAt(0).toUpperCase()
                };
                
                familyMembers.push(newMember);
                addMemberMarker(newMember);
                initializeUI();
                alert(`${name} has been added to your family circle!`);
            }
        });
        
        // Consent toggle handler
        document.getElementById('consentToggle').addEventListener('change', function() {
            if (!this.checked) {
                const user = familyMembers.find(m => m.id === 1);
                if (user && user.sharing) {
                    user.sharing = false;
                    user.status = "offline";
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                        userMarker = null;
                    }
                    if (userCircle) {
                        map.removeLayer(userCircle);
                        userCircle = null;
                    }
                    if (locationWatchId) {
                        navigator.geolocation.clearWatch(locationWatchId);
                        locationWatchId = null;
                    }
                    
                    initializeUI();
                    updateLocationStatus("Location sharing disabled via consent toggle.");
                    document.getElementById('locationInfo').innerHTML = "Your location will appear here when sharing";
                }
            }
        });
        
        // Initialize the application
        initializeUI();
        
        // Add click event to map to show coordinates (helpful for testing)
        map.on('click', function(e) {
            L.popup()
                .setLatLng(e.latlng)
                .setContent(`Coordinates:<br>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}`)
                .openOn(map);
        });
    </script>
</body>
</html>
